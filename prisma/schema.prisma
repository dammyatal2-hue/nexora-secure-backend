generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum AssetType {
  DOMAIN
  APP
  IDENTITY
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACKED
  RESOLVED
}

enum IncidentStatus {
  OPEN
  MITIGATING
  RESOLVED
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  industry  String?
  size      String?
  createdAt DateTime @default(now())

  users     User[]
  assets    Asset[]
  alerts    Alert[]
  incidents Incident[]
  logs      ActivityLog[]
}

model User {
  id           String      @id @default(uuid())
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  email        String
  name         String?
  passwordHash String
  role         UserRole    @default(MEMBER)
  status       UserStatus  @default(ACTIVE)
  createdAt    DateTime    @default(now())

  tokens       RefreshToken[]
  logs         ActivityLog[] @relation("ActorLogs")
  @@unique([orgId, email])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String
  createdAt DateTime @default(now())
  revokedAt DateTime?
}

model Asset {
  id        String    @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  type      AssetType
  name      String
  metadata  Json?
  createdAt DateTime  @default(now())

  alerts    Alert[]
  @@index([orgId, type])
}

model Alert {
  id        String        @id @default(uuid())
  orgId     String
  org       Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assetId   String?
  asset     Asset?        @relation(fields: [assetId], references: [id], onDelete: SetNull)
  type      String
  severity  AlertSeverity
  status    AlertStatus   @default(OPEN)
  title     String
  details   Json?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([orgId, status])
  @@index([orgId, severity])
}

model Incident {
  id        String         @id @default(uuid())
  orgId     String
  org       Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title     String
  severity  AlertSeverity
  status    IncidentStatus @default(OPEN)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  steps     IncidentStep[]
  @@index([orgId, status])
}

model IncidentStep {
  id           String   @id @default(uuid())
  incidentId   String
  incident     Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  stepOrder    Int
  title        String
  instructions String
  done         Boolean  @default(false)
}

model ActivityLog {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actorUserId String?
  actor       User?    @relation("ActorLogs", fields: [actorUserId], references: [id], onDelete: SetNull)
  action      String
  entityType  String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([orgId, createdAt])
}
